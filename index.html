<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stopwatch 10s - Leaderboard</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#1e3c72;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh}
.c{background:rgba(0,0,0,.4);padding:30px;border-radius:20px;max-width:420px;width:90%;text-align:center}
.t{font:bold 3.5em/1em monospace;margin:20px 0}
button{background:#ff4757;color:#fff;border:none;padding:15px 30px;font-size:1.2em;border-radius:50px;cursor:pointer;margin:10px}
button:disabled{background:#636e72;cursor:not-allowed}
.r{margin-top:20px;font-size:1.3em;padding:10px;border-radius:10px;background:rgba(255,255,255,.1)}
.p{color:#2ed573;animation:p 1s infinite}
.sbtn{background:#00bcd4 !important;margin-top:15px}
.lb{margin-top:20px;text-align:left;max-height:200px;overflow-y:auto}
.lb h3{margin:0 0 10px}
.lb ul{margin:0;padding:0;list-style:none}
.lb li{padding:8px;background:rgba(255,255,255,.1);margin:5px 0;border-radius:5px;display:flex;justify-content:space-between}
.rank{color:#ffd700;font-weight:bold}
@keyframes p{50%{transform:scale(1.05)}}
</style>
</head>
<body>
<div class="c">
  <h1>Stopwatch Challenge</h1>
  <p>Stop <b>exactly</b> at <b>00:10.000</b></p>
  <div class="t" id="d">00:00.000</div>
  <button id="s">Start</button>
  <button id="t" disabled>Stop</button>
  <div class="r" id="r">Ready? Nail 10 seconds!</div>
  
  <div class="lb" id="lb" style="display:none">
    <h3>TOP 10</h3>
    <ul id="lb-list"></ul>
  </div>
  
  <button id="showLb" class="sbtn" style="display:none">View Leaderboard</button>
</div>

<script>
// === CONFIG ===
const BOT_USERNAME = 'stopwatch10s_bot'  // ← CHANGE TO YOUR BOT

// === TELEGRAM + CONFETTI ===
const TG = window.Telegram?.WebApp
if (TG) { TG.ready(); TG.expand() }

const TARGET = 10000, PERFECT = 50, CLOSE = 200
const d = document.getElementById('d'), s = document.getElementById('s'), t = document.getElementById('t'), r = document.getElementById('r')
const lb = document.getElementById('lb'), lbList = document.getElementById('lb-list'), showLb = document.getElementById('showLb')
let start = 0, elapsed = 0, interval = null, running = false
let userId = TG?.initDataUnsafe?.user?.id || 'anon'
let userName = TG?.initDataUnsafe?.user?.first_name || 'Player'
let lastDiff = 0, lastRank = 0

// === ERROR DISPLAY ===
function showError(msg) {
  r.innerHTML = `<span style="color:#ff6b6b">⚠️ ${msg}</span>`
  r.className = 'r'
}

// === API CALLS WITH ERROR HANDLING ===
async function saveScore(diff) {
  const score = { id: userId, diff, time: Date.now(), name: userName }
  try {
    const res = await fetch('/api/score', {
      method: 'POST',
      body: JSON.stringify(score),
      headers: { 'Content-Type': 'application/json' }
    })
    if (!res.ok) throw new Error(await res.text())
  } catch (e) {
    showError('Save failed: ' + e.message)
  }
}

async function getLeaderboard() {
  try {
    const res = await fetch('/api/leaderboard?' + Date.now()) // bust cache
    if (!res.ok) throw new Error(await res.text())
    return await res.json()
  } catch (e) {
    showError('Load failed: ' + e.message)
    return []
  }
}

async function loadLb() {
  const scores = await getLeaderboard()
  if (scores.length === 0) {
    lbList.innerHTML = '<li>No scores yet!</li>'
  } else {
    lastRank = scores.findIndex(s => s.id === userId) + 1
    lbList.innerHTML = scores.slice(0,10).map((s,i) =>
      `<li><span class="rank">#${i+1}</span> ${s.name}: ±${s.diff}ms</li>`
    ).join('')
  }
  lb.style.display = 'block'
}

// === REST OF GAME (unchanged) ===
function format(ms) { /* same as before */ }
function update() { d.textContent = format(elapsed) }

// tick sound, confetti, etc. (copy from previous version)

function startTimer() { /* same */ }
async function stopTimer() {
  /* same until save */
  lastDiff = Math.abs(elapsed - TARGET)
  await saveScore(lastDiff)
  await loadLb()  // Auto-show leaderboard
  /* rest same */
}
function reset() { /* same */ }

s.onclick = () => { reset(); startTimer() }
t.onclick = stopTimer
showLb.onclick = loadLb
reset()
</script>
