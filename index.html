<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stopwatch 10s - Leaderboard</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#1e3c72;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh}
.c{background:rgba(0,0,0,.4);padding:30px;border-radius:20px;max-width:420px;width:90%;text-align:center}
.t{font:bold 3.5em/1em monospace;margin:20px 0}
button{background:#ff4757;color:#fff;border:none;padding:15px 30px;font-size:1.2em;border-radius:50px;cursor:pointer;margin:10px}
button:disabled{background:#636e72;cursor:not-allowed}
.r{margin-top:20px;font-size:1.3em;padding:10px;border-radius:10px;background:rgba(255,255,255,.1)}
.p{color:#2ed573;animation:p 1s infinite}
.sbtn{background:#00bcd4 !important;margin-top:15px}
.lb{margin-top:20px;text-align:left;max-height:200px;overflow-y:auto}
.lb h3{margin:0 0 10px}
.lb ul{margin:0;padding:0;list-style:none}
.lb li{padding:8px;background:rgba(255,255,255,.1);margin:5px 0;border-radius:5px;display:flex;justify-content:space-between}
.rank{color:#ffd700;font-weight:bold}
@keyframes p{50%{transform:scale(1.05)}}
</style>
</head>
<body>
<div class="c">
  <h1>Stopwatch Challenge</h1>
  <p>Stop <b>exactly</b> at <b>00:10.000</b></p>
  <div class="t" id="d">00:00.000</div>
  <button id="s">Start</button>
  <button id="t" disabled>Stop</button>
  <div class="r" id="r">Ready? Nail 10 seconds!</div>
  
  <div class="lb" id="lb" style="display:none">
    <h3>TOP 10</h3>
    <ul id="lb-list"></ul>
  </div>
  
  <button id="showLb" class="sbtn" style="display:none">View Leaderboard</button>
</div>

<script>
// === CONFIG: CHANGE THIS TO YOUR BOT USERNAME ===
const BOT_USERNAME = 'stopwatch10s_bot';  // ← YOUR BOT HERE

// === TELEGRAM + CONFETTI + SOUND ===
const TG = window.Telegram?.WebApp;
if (TG) { TG.ready(); TG.expand(); }

const TARGET = 10000, PERFECT = 50, CLOSE = 200;
const d = document.getElementById('d'), s = document.getElementById('s'), t = document.getElementById('t'), r = document.getElementById('r');
const lb = document.getElementById('lb'), lbList = document.getElementById('lb-list'), showLb = document.getElementById('showLb');
let start = 0, elapsed = 0, interval = null, running = false;
let userId = TG?.initDataUnsafe?.user?.id || 'anon_' + Math.random().toString(36).substr(2,9);
let userName = TG?.initDataUnsafe?.user?.first_name || 'Player';
let lastDiff = 0, lastRank = 0;

// === SOUND EFFECTS ===
const tickSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQg==');
const winSound = new Audio('data:audio/wav;base64,UklGRl4GAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0Yf4GAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQg==');

// === FORMAT TIME ===
function format(ms) {
  const mins = Math.floor(ms / 60000).toString().padStart(2, '0');
  const secs = Math.floor(ms / 1000) % 60;
  const s = secs.toString().padStart(2, '0');
  const msStr = (ms % 1000).toString().padStart(3, '0');
  return `${mins}:${s}.${msStr}`;
}
function update() { d.textContent = format(elapsed); }

// === API CALLS ===
async function saveScore(diff) {
  const score = { id: userId, diff, time: Date.now(), name: userName };
  try {
    const res = await fetch('/api/score', {
      method: 'POST',
      body: JSON.stringify(score),
      headers: { 'Content-Type': 'application/json' }
    });
    return res.ok;
  } catch (e) { console.error('Save failed:', e); return false; }
}

async function getLeaderboard() {
  try {
    const res = await fetch('/api/leaderboard');
    if (!res.ok) throw new Error('Failed');
    return await res.json();
  } catch (e) { console.error('Load failed:', e); return []; }
}

async function loadLb() {
  const scores = await getLeaderboard();
  lastRank = scores.findIndex(s => s.id === userId) + 1;
  lbList.innerHTML = scores.slice(0,10).map((s,i) =>
    `<li><span class="rank">#${i+1}</span> ${s.name}: ±${s.diff}ms</li>`
  ).join('') || '<li>No scores yet!</li>';
  lb.style.display = 'block';
}

// === SHARE FUNCTION ===
function shareScore() {
  const time = format(elapsed);
  const rankText = lastRank > 0 ? ` | Rank #${lastRank}` : '';
  const text = `I hit ${time} (±${lastDiff}ms) in Stopwatch Challenge!${rankText}\n\nPlay now: https://t.me/${BOT_USERNAME}/app`;
  
  if (TG) {
    TG.showPopup({
      title: 'Share your score!',
      message: text,
      buttons: [{ type: 'default', text: 'Share', id: 'share' }]
    }, (btn) => {
      if (btn === 'share') {
        const url = `https://t.me/share/url?url=${encodeURIComponent(text)}`;
        TG.openTelegramLink(url);
      }
    });
  } else {
    alert(text);
  }
}

// === GAME LOGIC ===
function startTimer() {
  if (running) return;
  running = true; start = Date.now() - elapsed;
  s.disabled = true; t.disabled = false; showLb.style.display = 'none';
  r.textContent = 'Go! Stop at 00:10.000'; r.className = 'r';
  interval = setInterval(() => {
    elapsed = Date.now() - start;
    update();
    tickSound.currentTime = 0; tickSound.play().catch(() => {});
  }, 7);
}

async function stopTimer() {
  if (!running) return;
  clearInterval(interval); running = false;
  s.disabled = false; t.disabled = true;
  lastDiff = Math.abs(elapsed - TARGET);
  
  await saveScore(lastDiff);
  await loadLb();
  
  let msg = '', cls = 'r';
  if (lastDiff <= PERFECT) {
    msg = `PERFECT!<br>${format(elapsed)} (±${lastDiff} ms)`;
    cls = 'r p';
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    winSound.play();
  } else if (lastDiff <= CLOSE) {
    msg = `Close!<br>${format(elapsed)} (${(lastDiff/1000).toFixed(2)}s off)`;
  } else {
    msg = `${format(elapsed)}<br>${(lastDiff/1000).toFixed(2)}s off`;
  }
  r.innerHTML = msg; r.className = cls;
  
  showLb.style.display = 'block';
  showLb.onclick = loadLb;
  
  // ADD SHARE BUTTON
  setTimeout(() => {
    if (document.querySelector('.share-btn')) return;
    const btn = document.createElement('button');
    btn.textContent = 'Share Score';
    btn.className = 'sbtn share-btn';
    btn.onclick = shareScore;
    document.querySelector('.c').appendChild(btn);
  }, 100);
}

function reset() {
  clearInterval(interval); running = false; elapsed = 0;
  s.disabled = false; t.disabled = true; update();
  r.textContent = 'Ready? Nail 10 seconds!'; r.className = 'r';
  showLb.style.display = 'none'; lb.style.display = 'none';
  const old = document.querySelector('.share-btn'); if (old) old.remove();
}

// === EVENTS ===
s.onclick = () => { reset(); startTimer(); };
t.onclick = stopTimer;
reset();
</script>
</body>
</html>
